apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  namespace: {{ .Values.targetNamespace }}   
  name: k4e-worker-rpm-build-pipeline
spec:
  params:
    - name: source-git-url
      description: Worker Source Repository URL
      default: {{ $.Values.source.worker.repoURL }}
      type: string
    - name: source-git-branch
      description: Worker Source Repository Branch Reference
      default: {{ $.Values.source.worker.branch }}
      type: string
    - name: tools-git-url
      description: K4E Build Repository URL
      default: {{ $.Values.source.tools.repoURL }}
      type: string
    - name: tools-git-branch
      description: K4E Build Repository Branch Reference
      default: {{ $.Values.source.tools.branch }}
      type: string            
  workspaces:
    - name: shared-workspace
  tasks:
    - name: git-clone-tools
      taskRef:
        name: git-clone
        kind: ClusterTask
      params:
        - name: url
          value: $(params.tools-git-url)
        - name: revision
          value: $(params.tools-git-branch)
        - name: subdirectory
          value: "tools"
      workspaces:
        - name: output
          workspace: shared-workspace          
    - name: git-clone-source
      taskRef:
        name: git-clone
        kind: ClusterTask
      params:
        - name: url
          value: $(params.source-git-url)
        - name: revision
          value: $(params.source-git-branch)
        - name: subdirectory
          value: "source"
      workspaces:
        - name: output
          workspace: shared-workspace          
    - name: k4e-build-worker-task
      taskRef:
        name: k4e-build-task
        kind: Task
      params:
        - name: source-dir
          value: /workspace/workspace/source
      runAfter:
        - "git-clone-source"
        - "git-clone-tools"
      workspaces:
        - name: workspace
          workspace: shared-workspace